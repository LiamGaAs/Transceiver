--- N_DEV_ADMSHBT_X.h	2015-03-04 15:58:18.000000000 -0700
+++ N_DEV_ADMSHBT_X.h	2015-03-04 16:15:43.000000000 -0700
@@ -1067,66 +1067,78 @@
 
 
 // Analog Function Vt
-template<typename ScalarT> ScalarT Vt(ScalarT U, ScalarT Ud)
+template<typename RetScalarT,typename Arg1ScalarT, typename Arg2ScalarT> RetScalarT Vt(Arg1ScalarT U, Arg2ScalarT Ud)
 {
 
 
-  ScalarT Vt;
-  ScalarT Vch;
-  ScalarT VF;
+  RetScalarT Vt;
+  Arg2ScalarT Vch;
+  Arg2ScalarT VF;
+  RetScalarT exparg;
   {
     Vch = (0.1*Ud);
     VF = (0.9*Ud);
     if ((U<VF))
     {
-      Vt = (U-(Vch*log((1.0+exp(((U-VF)/Vch))))));
+      exparg=((U-VF)/Vch);
+      Vt = (U-(Vch*log((1.0+exp(exparg)))));
     }
     else
     {
-      Vt = (VF-(Vch*log((1.0+exp(((VF-U)/Vch))))));
+      exparg=((VF-U)/Vch);
+      Vt = (VF-(Vch*log((1.0+exp(exparg)))));
     }
   }
   return(Vt);
 }
 
 
-// Analog Function diode
-template<typename ScalarT> ScalarT diode(ScalarT U, ScalarT Is, ScalarT Ug, ScalarT N, ScalarT AREA, ScalarT TJ, ScalarT TNOM)
+// Analog Function diode/
+// something of an abuse, we assume arg2, 5, 7 are all of compatible types
+template<typename RetScalarT,typename Arg1ScalarT, typename Arg2ScalarT,typename Arg3ScalarT,typename Arg4ScalarT, typename Arg5ScalarT, typename Arg6ScalarT, typename Arg7ScalarT>
+RetScalarT diode(Arg1ScalarT U, Arg2ScalarT Is, Arg3ScalarT Ug, Arg4ScalarT N, Arg5ScalarT AREA, Arg6ScalarT TJ, Arg7ScalarT TNOM)
 {
 
 
-  ScalarT diode;
-  ScalarT VTH0;
-  ScalarT VTHJ;
-  ScalarT VTHNOM;
-  ScalarT maxi;
-  ScalarT Tmax;
-  ScalarT TJM;
-  ScalarT KDURCHQ;
-  ScalarT lnIs;
+  RetScalarT diode;
+  RetScalarT exparg1;
+  RetScalarT exparg2;
+  RetScalarT VTH0;
+  Arg6ScalarT VTHJ;
+  Arg7ScalarT VTHNOM;
+  double maxi;
+  Arg3ScalarT Tmax;
+  Arg6ScalarT TJM;
+  Arg6ScalarT TJM_arg1;
+  double KDURCHQ;
+  RetScalarT lnIs;
   {
-    VTH0 = adms_vt((20.0+273.15));
-    VTHNOM = adms_vt((TNOM+273.15));
+    VTH0 = adms_vt<RetScalarT>((20.0+273.15));
+    VTHNOM = adms_vt<Arg7ScalarT>((TNOM+273.15));
     KDURCHQ = 0.861708692e-4;
     lnIs = log((Is*AREA));
     maxi = log(static_cast<double>(1e6));
     if (((maxi<(Ug/VTHNOM))&&(U<0.0)))
     {
       Tmax = (((Ug*VTHNOM)/((Ug-(maxi*VTHNOM))*KDURCHQ))-273.15);
-      TJM = Vt<ScalarT>(TJ,Tmax);
+      TJM = Vt<Arg6ScalarT>(TJ,Tmax);
     }
     else
     {
       TJM = TJ;
     }
-    VTHJ = adms_vt((TJM+273.15));
+    TJM_arg1=(TJM+273.15);
+    VTHJ = adms_vt(TJM_arg1);
     if ((Ug>0.0))
     {
-      diode = (exp_soft<ScalarT>(((((U/(N*VTHJ))+(Ug/VTHNOM))-(Ug/VTHJ))+lnIs))-exp_soft<ScalarT>((((Ug/VTHNOM)-(Ug/VTHJ))+lnIs)));
+      exparg1=((((U/(N*VTHJ))+(Ug/VTHNOM))-(Ug/VTHJ))+lnIs);
+      exparg2=(((Ug/VTHNOM)-(Ug/VTHJ))+lnIs);
+      diode = (exp_soft(exparg1)-exp_soft(exparg2));
     }
     else
     {
-      diode = (exp_soft<ScalarT>(((U/(N*VTH0))+lnIs))-(Is*AREA));
+      exparg1=((U/(N*VTH0))+lnIs);
+      diode = (exp_soft(exparg1)-(Is*AREA));
     }
   }
   return(diode);
@@ -1189,17 +1201,17 @@
 
 
 // Analog Function charge
-template<typename ScalarT> ScalarT charge(ScalarT U, ScalarT C0, ScalarT Ud, ScalarT m, ScalarT Area)
+template< typename RetScalarT, typename Arg2ScalarT, typename Arg3ScalarT, typename Arg4ScalarT, typename Arg5ScalarT> RetScalarT charge(RetScalarT U, Arg2ScalarT C0, Arg3ScalarT Ud, Arg4ScalarT m, Arg5ScalarT Area)
 {
 
 
-  ScalarT charge;
-  ScalarT Vj;
-  ScalarT Vjo;
-  ScalarT VF;
+  RetScalarT charge;
+  RetScalarT Vj;
+  RetScalarT Vjo;
+  RetScalarT VF;
   {
-    Vj = Vt<ScalarT>(U,Ud);
-    Vjo = Vt<ScalarT>(0.0,Ud);
+    Vj = Vt<RetScalarT>(U,Ud);
+    Vjo = Vt<RetScalarT>(0.0,Ud);
     VF = (0.9*Ud);
     if ((m==1.0))
     {
